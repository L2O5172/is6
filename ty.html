<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>å°ç£å°åƒåº— - LINE å¿«é€Ÿè¨‚é¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            background-color: #f7fafc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out forwards; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.5s ease-out; }
        .clickable-btn {
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
        }
        .clickable-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useCallback, useEffect, useMemo } = React;

        // é…ç½®
        const LIFF_ID = '2008316489-6nMjb0KX';
        const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxR1gzQgV1jq8DUhYX8EY0EmA6i2PBnjo_IZJUuwRgj7Ggjgro8Mdbnic7ZdhIIc2B1/exec';
        const DELIVERY_FEE = 30;
        const STORE_LINE_ID = '@561zotgq'; // åº—å®¶ LINE ID

        // é»˜èªèœå–®
        const DEFAULT_MENU = [
            { name: 'æ»·è‚‰é£¯', price: 35, icon: 'ğŸš', status: 'ä¾›æ‡‰ä¸­', image: 'https://images.unsplash.com/photo-1541519227354-08fa5d50c44d?w=400&h=300&fit=crop' },
            { name: 'é›è‚‰é£¯', price: 40, icon: 'ğŸ—', status: 'ä¾›æ‡‰ä¸­', image: 'https://images.unsplash.com/photo-1586190848861-99aa4a171e90?w=400&h=300&fit=crop' },
            { name: 'èšµä»”ç…', price: 65, icon: 'ğŸ³', status: 'ä¾›æ‡‰ä¸­', image: 'https://images.unsplash.com/photo-1563245372-f21724e3856d?w=400&h=300&fit=crop' },
            { name: 'å¤§è…¸éºµç·š', price: 50, icon: 'ğŸœ', status: 'ä¾›æ‡‰ä¸­', image: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?w=400&h=300&fit=crop' },
            { name: 'çç å¥¶èŒ¶', price: 45, icon: 'ğŸ¥¤', status: 'ä¾›æ‡‰ä¸­', image: 'https://images.unsplash.com/photo-1572490122747-3968b75cc699?w=400&h=300&fit=crop' }
        ];

        // API æœå‹™
        const apiService = {
            async request(payload) {
                try {
                    console.log('ç™¼é€è«‹æ±‚:', payload.action);
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('æ”¶åˆ°å›æ‡‰:', result);
                    return result;
                } catch (error) {
                    console.error('API è«‹æ±‚å¤±æ•—:', error);
                    throw new Error('ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå’Œä¼ºæœå™¨ç‹€æ…‹');
                }
            },

            async getMenu() {
                try {
                    const result = await this.request({ action: 'getMenu' });
                    if (result.success && Array.isArray(result.data)) {
                        return result.data;
                    }
                    return DEFAULT_MENU;
                } catch (error) {
                    console.warn('ç²å–èœå–®å¤±æ•—ï¼Œä½¿ç”¨é»˜èªèœå–®:', error);
                    return DEFAULT_MENU;
                }
            },
            
            async submitOrder(orderData, idToken) {
                const orderDataForServer = {
                    customerName: orderData.customerName.trim(),
                    customerPhone: orderData.customerPhone.trim(),
                    items: orderData.items.map(item => ({ 
                        name: item.name, 
                        quantity: item.quantity,
                        price: item.price 
                    })),
                    pickupTime: orderData.pickupTime,
                    deliveryAddress: orderData.deliveryAddress.trim(),
                    notes: orderData.notes.trim(),
                    status: 'pending' // é è¨­ç‚ºå¾…ç¢ºèªç‹€æ…‹
                };

                console.log('æäº¤è¨‚å–®æ•¸æ“š:', orderDataForServer);

                const result = await this.request({ 
                    action: 'createOrder', 
                    idToken: idToken,
                    orderData: orderDataForServer 
                });

                if (!result.success) {
                    throw new Error(result.message || 'è¨‚å–®æäº¤å¤±æ•—');
                }

                return result;
            },

            async getOrders(params) {
                const searchParams = {
                    ...params,
                    customerPhone: params.customerPhone ? params.customerPhone.trim() : '',
                    exactMatch: true
                };

                const result = await this.request({ 
                    action: 'getOrders', 
                    ...searchParams 
                });

                if (!result.success) {
                    throw new Error(result.message || 'æŸ¥è©¢å¤±æ•—');
                }

                return result.data || [];
            },

            async checkOrderStatus(orderId) {
                const result = await this.request({
                    action: 'checkOrderStatus',
                    orderId: orderId
                });

                if (!result.success) {
                    throw new Error(result.message || 'æŸ¥è©¢ç‹€æ…‹å¤±æ•—');
                }

                return result.data;
            }
        };

        // LINE LIFF Hook
        const useLiff = () => {
            const [profile, setProfile] = useState(null);
            const [idToken, setIdToken] = useState(null);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [liffStatus, setLiffStatus] = useState('ğŸ”„ åˆå§‹åŒ– LINE åŠŸèƒ½ä¸­...');
            const [statusType, setStatusType] = useState('info');

            useEffect(() => {
                const initializeLiff = async () => {
                    try {
                        await liff.init({ liffId: LIFF_ID });
                        if (liff.isLoggedIn()) {
                            setIsLoggedIn(true);
                            const [userProfile, token] = await Promise.all([
                                liff.getProfile(),
                                liff.getIDToken()
                            ]);
                            setProfile(userProfile);
                            setIdToken(token);
                            setLiffStatus(`ğŸ‘‹ æ­¡è¿ï¼Œ${userProfile.displayName}ï¼`);
                            setStatusType('success');
                        } else {
                            if (liff.isInClient()) {
                                setLiffStatus('æœªç™»å…¥ LINEï¼Œæ­£åœ¨å˜—è©¦ç™»å…¥...');
                                liff.login();
                            } else {
                                setLiffStatus('è«‹åœ¨ LINE App ä¸­é–‹å•Ÿä»¥ç²å¾—å®Œæ•´åŠŸèƒ½ã€‚');
                                setStatusType('warning');
                            }
                        }
                    } catch (error) {
                        console.warn('LINE åˆå§‹åŒ–å¤±æ•—:', error);
                        setLiffStatus('âš ï¸ LINE åŠŸèƒ½è¼‰å…¥å¤±æ•—ï¼Œä½†æ‚¨ä»å¯è¨‚é¤ã€‚');
                        setStatusType('warning');
                    }
                };
                
                if (window.liff) {
                    initializeLiff();
                } else {
                    setLiffStatus('âš ï¸ LINE SDK è¼‰å…¥å¤±æ•—ï¼Œä½†æ‚¨ä»å¯è¨‚é¤ã€‚');
                    setStatusType('warning');
                }
            }, []);

            return { profile, idToken, isLoggedIn, liffStatus, statusType };
        };

        // åŠ è¼‰å‹•ç•«çµ„ä»¶
        const LoadingSpinner = () => (
            <svg className="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );

        // é€šçŸ¥çµ„ä»¶
        const Notification = ({ message, type, visible, onClose }) => {
            useEffect(() => {
                if (visible) {
                    const timer = setTimeout(onClose, 4000);
                    return () => clearTimeout(timer);
                }
            }, [visible, onClose]);

            if (!visible) return null;
            
            const typeClasses = {
                success: "bg-green-500 text-white",
                error: "bg-red-500 text-white",
                warning: "bg-yellow-500 text-white",
                info: "bg-blue-500 text-white"
            };
            
            return (
                <div className={`fixed top-5 right-5 max-w-sm p-4 rounded-lg shadow-lg z-50 animate-slide-in ${typeClasses[type]}`}>
                    <div className="flex justify-between items-center">
                        <p className="text-sm font-medium whitespace-pre-wrap">{message}</p>
                        <button onClick={onClose} className="ml-4 text-xl font-bold leading-none">&times;</button>
                    </div>
                </div>
            );
        };

        // è¨‚å–®ç‹€æ…‹æª¢æŸ¥çµ„ä»¶
        const OrderStatusChecker = ({ orderId, onStatusChange }) => {
            const [status, setStatus] = useState('pending');
            const [isChecking, setIsChecking] = useState(false);

            const checkStatus = async () => {
                setIsChecking(true);
                try {
                    const result = await apiService.checkOrderStatus(orderId);
                    setStatus(result.status);
                    onStatusChange(result.status);
                } catch (error) {
                    console.error('æª¢æŸ¥ç‹€æ…‹å¤±æ•—:', error);
                } finally {
                    setIsChecking(false);
                }
            };

            useEffect(() => {
                // æ¯30ç§’è‡ªå‹•æª¢æŸ¥ä¸€æ¬¡ç‹€æ…‹
                const interval = setInterval(checkStatus, 30000);
                return () => clearInterval(interval);
            }, []);

            const getStatusInfo = () => {
                const statusConfig = {
                    'pending': { 
                        color: 'bg-yellow-100 border-yellow-400 text-yellow-800',
                        icon: 'â³',
                        text: 'ç­‰å¾…åº—å®¶ç¢ºèª',
                        description: 'å·²ç™¼é€ç¢ºèªä¿¡ï¼Œè«‹ç­‰å¾…åº—å®¶å›è¦†ç¢ºèª'
                    },
                    'confirmed': { 
                        color: 'bg-green-100 border-green-400 text-green-800',
                        icon: 'âœ…',
                        text: 'è¨‚å–®å·²ç¢ºèª',
                        description: 'åº—å®¶å·²ç¢ºèªæ‚¨çš„è¨‚å–®ï¼Œè«‹æº–æ™‚å–é¤'
                    },
                    'cancelled': { 
                        color: 'bg-red-100 border-red-400 text-red-800',
                        icon: 'âŒ',
                        text: 'è¨‚å–®å·²å–æ¶ˆ',
                        description: 'åº—å®¶å·²å–æ¶ˆæ­¤è¨‚å–®'
                    }
                };
                return statusConfig[status] || statusConfig.pending;
            };

            const statusInfo = getStatusInfo();

            return (
                <div className={`p-4 rounded-lg border ${statusInfo.color} mb-4`}>
                    <div className="flex items-center justify-between">
                        <div className="flex items-center">
                            <span className="text-2xl mr-3">{statusInfo.icon}</span>
                            <div>
                                <h3 className="font-bold">{statusInfo.text}</h3>
                                <p className="text-sm opacity-80">{statusInfo.description}</p>
                            </div>
                        </div>
                        <button 
                            onClick={checkStatus}
                            disabled={isChecking}
                            className="bg-blue-500 text-white px-3 py-1 rounded text-sm disabled:bg-gray-400 clickable-btn"
                        >
                            {isChecking ? <LoadingSpinner /> : 'åˆ·æ–°'}
                        </button>
                    </div>
                </div>
            );
        };

        // æˆåŠŸé é¢ - ä¿®æ”¹åŠ å…¥å¥½å‹åŠŸèƒ½ï¼Œç›´æ¥å¸¶å…¥ç¢ºèªä¿¡å…§å®¹
        const SuccessPage = ({ orderData, onNewOrder, showNotification }) => {
            const formatDisplayTime = (timestamp) => new Date(timestamp).toLocaleString('zh-TW');
            const [currentStatus, setCurrentStatus] = useState('pending');
            
            // çµ¦åº—å®¶çš„ç¢ºèªä¿¡å…§å®¹
            const storeConfirmationText = `ğŸª ã€å°ç£å°åƒåº— - è¨‚å–®ç¢ºèªä¿¡ã€‘\n\nğŸ“‹ è¨‚å–®ç·¨è™Ÿï¼š${orderData.orderId}\nğŸ‘¤ é¡§å®¢å§“åï¼š${orderData.customerName}\nğŸ“ è¯çµ¡é›»è©±ï¼š${orderData.customerPhone}\n\nğŸ›’ è¨‚å–®å…§å®¹ï¼š\n${orderData.items.map(item => `â€¢ ${item.name} x ${item.quantity} = $${item.price * item.quantity}`).join('\n')}\n\nğŸ’° ç¸½é‡‘é¡ï¼š$${orderData.totalAmount}\nâ° å–é¤æ™‚é–“ï¼š${formatDisplayTime(orderData.pickupTime)}\nğŸ“ ${orderData.deliveryAddress ? `å¤–é€åœ°å€ï¼š${orderData.deliveryAddress}` : 'è‡ªå–'}\nğŸ“ å‚™è¨»ï¼š${orderData.notes || 'ç„¡'}\n\nâ±ï¸ ä¸‹å–®æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\n\nâš ï¸ è«‹å›è¦†ã€Œç¢ºèªã€ä»¥ç¢ºèªæ­¤è¨‚å–®\nâŒ å›è¦†ã€Œå–æ¶ˆã€ä»¥å–æ¶ˆæ­¤è¨‚å–®\n\nğŸ’¬ ç¢ºèªå¾Œè¨‚å–®æ‰æ­£å¼æˆç«‹`;

            // çµ¦å®¢äººçš„è¨‚å–®å…§å®¹
            const customerShareText = `ğŸ½ï¸ å°ç£å°åƒåº— - è¨‚å–®è©³ç´°è³‡è¨Š\n\nğŸ“‹ è¨‚å–®ç·¨è™Ÿï¼š${orderData.orderId}\nğŸ‘¤ é¡§å®¢å§“åï¼š${orderData.customerName}\nğŸ“ è¯çµ¡é›»è©±ï¼š${orderData.customerPhone}\n\nğŸ’° ç¸½é‡‘é¡ï¼š$${orderData.totalAmount}\nâ° å–é¤æ™‚é–“ï¼š${formatDisplayTime(orderData.pickupTime)}\nğŸ“ ${orderData.deliveryAddress ? `å¤–é€åœ°å€ï¼š${orderData.deliveryAddress}` : 'è‡ªå–'}\nğŸ“ å‚™è¨»ï¼š${orderData.notes || 'ç„¡'}\n\nâš ï¸ è«‹å‹™å¿…ç™¼é€ç¢ºèªä¿¡çµ¦åº—å®¶ï¼Œå¾…åº—å®¶ç¢ºèªå¾Œè¨‚å–®æ‰æˆç«‹\nğŸ“ å–é¤åœ°å€ï¼šå°ç£å°åƒåº—\nğŸ•’ ç‡Ÿæ¥­æ™‚é–“ï¼š10:00-21:00\nğŸ“ åº—å®¶é›»è©±ï¼š02-1234-5678`;

            const copyToClipboard = (text, successMessage) => {
                navigator.clipboard.writeText(text)
                    .then(() => showNotification(successMessage, 'success'))
                    .catch(() => showNotification('è¤‡è£½å¤±æ•—', 'error'));
            };

            // ç”ŸæˆåŠ å…¥å¥½å‹ä¸¦ç™¼é€ç¢ºèªä¿¡çš„é€£çµ
            const generateAddFriendAndSendLink = () => {
                // å…ˆåŠ å…¥å¥½å‹ï¼Œç„¶å¾Œç™¼é€ç¢ºèªä¿¡
                const addFriendUrl = `https://line.me/R/ti/p/${STORE_LINE_ID}`;
                const sendMessageUrl = `https://line.me/R/msg/text/?${encodeURIComponent(storeConfirmationText)}`;
                
                // ç”±æ–¼ç„¡æ³•åœ¨åŒä¸€å€‹é€£çµå®Œæˆå…©å€‹å‹•ä½œï¼Œæˆ‘å€‘æä¾›èªªæ˜
                return addFriendUrl;
            };

            return (
                <div className="text-center p-5 animate-fade-in">
                    <div className="text-6xl mb-5">ğŸ“¨</div>
                    <h3 className="text-2xl font-bold text-blue-600 mb-4">è¨‚å–®å·²æš«å­˜ï¼</h3>
                    <p className="text-gray-600 mb-6">è«‹ç™¼é€ç¢ºèªä¿¡çµ¦åº—å®¶ï¼Œå¾…åº—å®¶ç¢ºèªå¾Œè¨‚å–®æ‰æ­£å¼æˆç«‹</p>
                    
                    {/* è¨‚å–®ç‹€æ…‹æª¢æŸ¥ */}
                    <OrderStatusChecker 
                        orderId={orderData.orderId} 
                        onStatusChange={setCurrentStatus}
                    />

                    <div className="bg-gray-50 p-4 rounded-lg my-5 text-left border">
                        <p><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong><span className="font-mono">{orderData.orderId}</span></p>
                        <p><strong>é¡§å®¢å§“åï¼š</strong><span>{orderData.customerName}</span></p>
                        <p><strong>è¯çµ¡é›»è©±ï¼š</strong><span>{orderData.customerPhone}</span></p>
                        <p><strong>ç¸½é‡‘é¡ï¼š</strong>$<span className="text-green-600 font-bold">{orderData.totalAmount}</span></p>
                        <p><strong>å–é¤æ™‚é–“ï¼š</strong><span>{formatDisplayTime(orderData.pickupTime)}</span></p>
                        <p><strong>å–é¤æ–¹å¼ï¼š</strong><span>{orderData.deliveryAddress ? 'å¤–é€' : 'è‡ªå–'}</span></p>
                        {orderData.deliveryAddress && <p><strong>å¤–é€åœ°å€ï¼š</strong><span>{orderData.deliveryAddress}</span></p>}
                        {orderData.notes && <p><strong>å‚™è¨»ï¼š</strong><span>{orderData.notes}</span></p>}
                    </div>

                    {/* ç™¼é€ç¢ºèªä¿¡çµ¦åº—å®¶ - ä¿®æ”¹ç‚ºä¸€éµåŠ å…¥ä¸¦ç™¼é€ */}
                    <div className="my-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <h4 className="font-bold text-lg mb-3">ğŸ“¨ ç™¼é€ç¢ºèªä¿¡çµ¦åº—å®¶</h4>
                        <p className="text-sm text-gray-600 mb-4">
                            <span className="font-bold text-red-500">é‡è¦ï¼š</span> 
                            è«‹å‹™å¿…ç™¼é€ç¢ºèªä¿¡çµ¦åº—å®¶ï¼Œåº—å®¶å›è¦†ç¢ºèªå¾Œè¨‚å–®æ‰æˆç«‹
                        </p>
                        
                        <div className="space-y-3">
                            {/* ä¸€éµåŠ å…¥å¥½å‹ä¸¦ç™¼é€ç¢ºèªä¿¡ */}
                            <a 
                                href={`https://line.me/R/msg/text/?${encodeURIComponent(storeConfirmationText)}`}
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="block bg-green-500 text-white py-3 px-4 rounded-lg font-bold clickable-btn text-sm"
                                onClick={(e) => {
                                    // å…ˆæç¤ºç”¨æˆ¶
                                    if (!window.confirm('é€™å°‡é–‹å•ŸLINEä¸¦å¸¶å…¥ç¢ºèªä¿¡å…§å®¹ã€‚å¦‚æœé‚„æœªåŠ å…¥åº—å®¶å¥½å‹ï¼Œè«‹å…ˆæœå°‹ @561zotgq åŠ å…¥å¥½å‹ï¼Œç„¶å¾Œè²¼ä¸Šç¢ºèªä¿¡å…§å®¹ã€‚ç¢ºå®šç¹¼çºŒå—ï¼Ÿ')) {
                                        e.preventDefault();
                                    }
                                }}
                            >
                                ğŸ’¬ ä¸€éµç™¼é€ç¢ºèªä¿¡åˆ°LINE
                            </a>

                            {/* åŠ å…¥åº—å®¶LINEå¥½å‹ */}
                            <a 
                                href={`https://line.me/R/ti/p/${STORE_LINE_ID}`}
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="block bg-blue-500 text-white py-3 px-4 rounded-lg font-bold clickable-btn text-sm"
                            >
                                ğŸ‘¥ åŠ å…¥åº—å®¶LINEå¥½å‹
                            </a>
                            
                            {/* è¤‡è£½ç¢ºèªä¿¡å…§å®¹ */}
                            <button 
                                onClick={() => copyToClipboard(storeConfirmationText, 'ç¢ºèªä¿¡å·²è¤‡è£½ï¼è«‹è²¼åˆ°åº—å®¶LINE')}
                                className="w-full bg-purple-500 text-white py-3 px-4 rounded-lg font-bold clickable-btn text-sm"
                            >
                                ğŸ“‹ è¤‡è£½ç¢ºèªä¿¡å…§å®¹
                            </button>
                        </div>
                        
                        <div className="mt-4 p-3 bg-white rounded-lg border border-gray-300">
                            <p className="text-xs text-gray-800 font-bold">ğŸ“ æ¨è–¦æ“ä½œæ­¥é©Ÿï¼š</p>
                            <ol className="text-xs text-gray-600 mt-2 text-left list-decimal list-inside space-y-1">
                                <li>é»æ“Šã€Œä¸€éµç™¼é€ç¢ºèªä¿¡åˆ°LINEã€</li>
                                <li>å¦‚æœé‚„æœªåŠ å¥½å‹ï¼ŒLINEæœƒæç¤ºæ‰¾ä¸åˆ°ç”¨æˆ¶</li>
                                <li>é€™æ™‚é»æ“Šã€ŒåŠ å…¥åº—å®¶LINEå¥½å‹ã€å…ˆåŠ å…¥å¥½å‹</li>
                                <li>åŠ å…¥å¥½å‹å¾Œï¼Œå†æ¬¡é»æ“Šã€Œä¸€éµç™¼é€ç¢ºèªä¿¡åˆ°LINEã€</li>
                                <li>æˆ–ç›´æ¥ã€Œè¤‡è£½ç¢ºèªä¿¡å…§å®¹ã€è²¼åˆ°èˆ‡åº—å®¶çš„èŠå¤©å®¤</li>
                                <li>ç­‰å¾…åº—å®¶å›è¦†ã€Œç¢ºèªã€</li>
                            </ol>
                        </div>

                        <div className="mt-3 p-3 bg-red-50 rounded-lg border border-red-200">
                            <p className="text-xs text-red-800 font-bold">ğŸ’¡ å°æŠ€å·§ï¼š</p>
                            <ul className="text-xs text-red-600 mt-1 text-left list-disc list-inside space-y-1">
                                <li>å¦‚æœå·²ç¶“åŠ å…¥åº—å®¶å¥½å‹ï¼Œç›´æ¥ä½¿ç”¨ã€Œä¸€éµç™¼é€ã€æœ€æ–¹ä¾¿</li>
                                <li>å¦‚æœé‚„æ²’åŠ å…¥ï¼Œå…ˆåŠ å…¥å¥½å‹å¾Œå†ç™¼é€ç¢ºèªä¿¡</li>
                                <li>ç¢ºèªä¿¡å·²åŒ…å«å®Œæ•´è¨‚å–®è³‡è¨Šï¼Œç›´æ¥ç™¼é€å³å¯</li>
                            </ul>
                        </div>
                    </div>

                    {/* å¿«é€Ÿæ“ä½œå€ */}
                    <div className="my-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 className="font-bold text-lg mb-3">âš¡ å¿«é€Ÿæ“ä½œ</h4>
                        <div className="grid grid-cols-2 gap-2">
                            <a 
                                href={`https://line.me/R/ti/p/${STORE_LINE_ID}`}
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="bg-green-500 text-white py-2 px-3 rounded text-sm clickable-btn text-center"
                            >
                                â• åŠ å¥½å‹
                            </a>
                            <a 
                                href={`https://line.me/R/msg/text/?${encodeURIComponent(storeConfirmationText)}`}
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="bg-blue-500 text-white py-2 px-3 rounded text-sm clickable-btn text-center"
                            >
                                ğŸ“¤ ç™¼ç¢ºèªä¿¡
                            </a>
                            <button 
                                onClick={() => copyToClipboard(storeConfirmationText, 'ç¢ºèªä¿¡å·²è¤‡è£½ï¼')}
                                className="bg-purple-500 text-white py-2 px-3 rounded text-sm clickable-btn col-span-2"
                            >
                                ğŸ“‹ è¤‡è£½ç¢ºèªä¿¡
                            </button>
                        </div>
                    </div>

                    {/* å„²å­˜è¨‚å–®è³‡è¨Š */}
                    <div className="my-6 p-4 bg-green-50 rounded-lg border border-green-200">
                        <h4 className="font-bold text-lg mb-3">ğŸ’¾ å„²å­˜è¨‚å–®è³‡è¨Š</h4>
                        
                        <div className="space-y-3">
                            <a 
                                href={`https://line.me/R/msg/text/?${encodeURIComponent(customerShareText)}`} 
                                target="_blank" 
                                rel="noopener noreferrer" 
                                className="block bg-[#06c755] text-white py-3 px-4 rounded-lg font-bold clickable-btn text-sm"
                            >
                                ğŸ’¬ åˆ†äº«åˆ°è‡ªå·±çš„LINE
                            </a>
                            
                            <button 
                                onClick={() => copyToClipboard(customerShareText, 'è¨‚å–®è³‡è¨Šå·²è¤‡è£½ï¼')}
                                className="w-full bg-gray-500 text-white py-3 px-4 rounded-lg font-bold clickable-btn text-sm"
                            >
                                ğŸ“ è¤‡è£½è¨‚å–®è³‡è¨Š
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-3">
                        <button 
                            onClick={onNewOrder}
                            className="bg-green-600 text-white py-3 px-4 rounded-lg clickable-btn"
                        >
                            ğŸ“ å†è¨‚ä¸€å–®
                        </button>
                        <button 
                            onClick={() => window.location.reload()}
                            className="bg-blue-600 text-white py-3 px-4 rounded-lg clickable-btn"
                        >
                            ğŸ”„ åˆ·æ–°ç‹€æ…‹
                        </button>
                    </div>
                </div>
            );
        };

        // èœå“é …ç›®çµ„ä»¶
        const MenuItem = ({ item, cartQuantity, onUpdateCart }) => {
            return (
                <div className="bg-white rounded-lg p-4 border border-gray-200 shadow-sm mb-3">
                    <div className="flex items-center gap-3">
                        <div className="flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden">
                            <img src={item.image} alt={item.name} className="w-full h-full object-cover" />
                        </div>
                        
                        <div className="flex-1">
                            <div className="flex justify-between items-start mb-2">
                                <div>
                                    <h3 className="font-bold text-gray-800 text-sm">{item.icon} {item.name}</h3>
                                    <p className="text-green-600 font-bold text-sm">${item.price}</p>
                                </div>
                                <span className="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">
                                    {item.status}
                                </span>
                            </div>
                            
                            <div className="flex items-center gap-3">
                                <button
                                    onClick={() => onUpdateCart(item.name, -1)}
                                    disabled={cartQuantity === 0}
                                    className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold clickable-btn ${
                                        cartQuantity === 0 ? 'bg-gray-400 cursor-not-allowed' : 'bg-red-500 hover:bg-red-600'
                                    }`}
                                >-</button>
                                
                                <span className="min-w-8 text-center font-bold text-lg">{cartQuantity}</span>
                                
                                <button
                                    onClick={() => onUpdateCart(item.name, 1)}
                                    className="w-8 h-8 rounded-full bg-green-500 text-white font-bold hover:bg-green-600 clickable-btn"
                                >+</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // è¨‚é¤é é¢
        const OrderPage = ({ menuItems, onSubmitOrder, showNotification, onViewHistory }) => {
            const { profile, idToken, liffStatus, statusType } = useLiff();
            const [cart, setCart] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [customerName, setCustomerName] = useState('');
            const [customerPhone, setCustomerPhone] = useState('');
            const [pickupDate, setPickupDate] = useState('');
            const [pickupTime, setPickupTime] = useState('');
            const [deliveryAddress, setDeliveryAddress] = useState('');
            const [notes, setNotes] = useState('');
            const [phoneError, setPhoneError] = useState('');
            const [timeError, setTimeError] = useState('');

            useEffect(() => {
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                setPickupDate(today);
                
                now.setMinutes(now.getMinutes() + 30);
                const minutes = Math.ceil(now.getMinutes() / 30) * 30;
                now.setMinutes(minutes);
                const timeString = now.toTimeString().slice(0, 5);
                setPickupTime(timeString);
            }, []);

            useEffect(() => {
                if (profile?.displayName) {
                    setCustomerName(profile.displayName);
                }
            }, [profile]);

            const { subtotal, deliveryFee, totalAmount } = useMemo(() => {
                const sub = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const fee = deliveryAddress.trim() ? DELIVERY_FEE : 0;
                return { subtotal: sub, deliveryFee: fee, totalAmount: sub + fee };
            }, [cart, deliveryAddress]);

            const updateCart = (itemName, change) => {
                setCart(prevCart => {
                    const existingIndex = prevCart.findIndex(item => item.name === itemName);
                    
                    if (existingIndex === -1) {
                        if (change > 0) {
                            const menuItem = menuItems.find(item => item.name === itemName);
                            return menuItem ? [...prevCart, { ...menuItem, quantity: 1 }] : prevCart;
                        }
                        return prevCart;
                    }
                    
                    const newCart = [...prevCart];
                    const currentQuantity = newCart[existingIndex].quantity;
                    const newQuantity = currentQuantity + change;
                    
                    if (newQuantity <= 0) {
                        newCart.splice(existingIndex, 1);
                    } else {
                        newCart[existingIndex] = { ...newCart[existingIndex], quantity: newQuantity };
                    }
                    
                    return newCart;
                });
            };

            const getItemQuantity = (itemName) => {
                const item = cart.find(item => item.name === itemName);
                return item ? item.quantity : 0;
            };

            const clearCart = () => {
                if (window.confirm('ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ')) {
                    setCart([]);
                }
            };

            const getDateOptions = () => {
                const dates = [];
                const today = new Date();
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() + i);
                    dates.push({
                        value: date.toISOString().split('T')[0],
                        label: date.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'short' })
                    });
                }
                
                return dates;
            };

            const getTimeOptions = () => {
                const times = [];
                for (let hour = 10; hour <= 21; hour++) {
                    for (let minute = 0; minute < 60; minute += 30) {
                        times.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
                    }
                }
                return times;
            };

            const getFullPickupTime = () => {
                return pickupDate && pickupTime ? `${pickupDate}T${pickupTime}` : '';
            };

            const validateForm = () => {
                let isValid = true;
                setPhoneError('');
                setTimeError('');

                if (!/^09\d{8}$/.test(customerPhone)) {
                    setPhoneError('è«‹è¼¸å…¥æœ‰æ•ˆçš„10ä½æ‰‹æ©Ÿè™Ÿç¢¼ (09é–‹é ­)');
                    isValid = false;
                }

                if (!pickupDate || !pickupTime) {
                    setTimeError('è«‹é¸æ“‡å–é¤æ—¥æœŸå’Œæ™‚é–“');
                    isValid = false;
                } else {
                    const selectedDateTime = new Date(getFullPickupTime());
                    const minDateTime = new Date();
                    minDateTime.setMinutes(minDateTime.getMinutes() + 29);
                    
                    if (selectedDateTime < minDateTime) {
                        setTimeError('å–é¤æ™‚é–“å¿…é ˆåœ¨30åˆ†é˜ä¹‹å¾Œ');
                        isValid = false;
                    }
                }
                
                if (cart.length === 0) {
                    showNotification('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é¤é»', 'error');
                    isValid = false;
                }
                
                return isValid;
            };

            const handleSubmit = async () => {
                if (!validateForm()) return;
                
                setIsLoading(true);
                try {
                    await onSubmitOrder({ 
                        customerName, 
                        customerPhone,
                        items: cart, 
                        pickupTime: getFullPickupTime(), 
                        deliveryAddress, 
                        notes 
                    }, idToken);
                } catch (error) {
                    // éŒ¯èª¤åœ¨çˆ¶çµ„ä»¶è™•ç†
                } finally {
                    setIsLoading(false);
                }
            };

            const statusClasses = { 
                info: 'bg-blue-100 border-blue-400 text-blue-800', 
                success: 'bg-green-100 border-green-400 text-green-800', 
                warning: 'bg-yellow-100 border-yellow-400 text-yellow-800', 
                error: 'bg-red-100 border-red-400 text-red-800' 
            };

            const dateOptions = getDateOptions();
            const timeOptions = getTimeOptions();

            return (
                <div className="animate-fade-in">
                    <div className={`p-3 rounded-lg text-sm text-center border ${statusClasses[statusType]}`}>{liffStatus}</div>
                    
                    <button onClick={onViewHistory} className="w-full text-center p-2.5 border border-blue-500 text-blue-600 rounded-md text-sm hover:bg-blue-500 hover:text-white transition-colors duration-200 mt-4 clickable-btn">
                        ğŸ•’ æŸ¥è©¢æ­·å²è¨‚å–®
                    </button>
                    
                    <div className="space-y-4 mt-4">
                        <div>
                            <label className="block mb-2 font-bold text-gray-700 text-sm">å§“å <span className="text-red-500">*</span></label>
                            <input 
                                type="text" 
                                value={customerName} 
                                onChange={(e) => setCustomerName(e.target.value)} 
                                placeholder="è‡ªå‹•å¸¶å…¥ LINE åç¨±" 
                                className="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-green-500 focus:border-green-500"
                            />
                        </div>
                        
                        <div>
                            <label className="block mb-2 font-bold text-gray-700 text-sm">æ‰‹æ©Ÿè™Ÿç¢¼ <span className="text-red-500">*</span></label>
                            <input 
                                type="tel" 
                                value={customerPhone} 
                                onChange={(e) => setCustomerPhone(e.target.value)} 
                                placeholder="0936220000"
                                className={`w-full p-3 border rounded-lg text-sm focus:ring-green-500 focus:border-green-500 ${phoneError ? 'border-red-500' : 'border-gray-300'}`}
                            />
                            {phoneError && <p className="text-red-500 text-xs mt-1">{phoneError}</p>}
                            <p className="text-xs text-gray-500 mt-1">è«‹è¼¸å…¥09é–‹é ­çš„10ä½æ‰‹æ©Ÿè™Ÿç¢¼</p>
                        </div>
                        
                        <div>
                            <label className="block mb-2 font-bold text-gray-700 text-sm">å–é¤æ—¥æœŸ <span className="text-red-500">*</span></label>
                            <select 
                                value={pickupDate} 
                                onChange={(e) => setPickupDate(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-green-500 focus:border-green-500"
                            >
                                <option value="">è«‹é¸æ“‡å–é¤æ—¥æœŸ</option>
                                {dateOptions.map(date => (
                                    <option key={date.value} value={date.value}>{date.label}</option>
                                ))}
                            </select>
                        </div>
                        
                        <div>
                            <label className="block mb-2 font-bold text-gray-700 text-sm">å–é¤æ™‚é–“ <span className="text-red-500">*</span></label>
                            <select 
                                value={pickupTime} 
                                onChange={(e) => setPickupTime(e.target.value)}
                                className={`w-full p-3 border rounded-lg text-sm focus:ring-green-500 focus:border-green-500 ${timeError ? 'border-red-500' : 'border-gray-300'}`}
                            >
                                <option value="">è«‹é¸æ“‡å–é¤æ™‚é–“</option>
                                {timeOptions.map(time => (
                                    <option key={time} value={time}>{time}</option>
                                ))}
                            </select>
                            {timeError && <p className="text-red-500 text-xs mt-1">{timeError}</p>}
                            <p className="text-xs text-gray-500 mt-1">ç‡Ÿæ¥­æ™‚é–“: 10:00 - 21:00</p>
                        </div>
                        
                        <div>
                            <label className="block mb-2 font-bold text-gray-700 text-sm">å¤–é€åœ°é» (é¸å¡«)</label>
                            <input 
                                type="text" 
                                value={deliveryAddress} 
                                onChange={(e) => setDeliveryAddress(e.target.value)} 
                                placeholder="å¦‚éœ€å¤–é€è«‹å¡«å¯«åœ°å€" 
                                className="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-green-500 focus:border-green-500"
                            />
                            <p className="text-xs text-gray-500 mt-1">â€» å¡«å¯«åœ°å€å°‡è¨ˆç®— ${DELIVERY_FEE} å¤–é€è²»</p>
                        </div>
                        
                        <div>
                            <label className="block mb-2 font-bold text-gray-700 text-sm">å‚™è¨» (é¸å¡«)</label>
                            <textarea 
                                value={notes} 
                                onChange={(e) => setNotes(e.target.value)} 
                                rows={2} 
                                placeholder="ä¾‹å¦‚ï¼šä¸è¦é¦™èœã€åŠ è¾£ç­‰" 
                                className="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-green-500 focus:border-green-500"
                            />
                        </div>
                    </div>
                    
                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 mt-4">
                        <h2 className="text-center text-lg font-bold text-gray-800 mb-4">ğŸ“ é¸æ“‡é¤é»</h2>
                        <div className="space-y-3">
                            {menuItems.map(item => (
                                <MenuItem
                                    key={item.name}
                                    item={item}
                                    cartQuantity={getItemQuantity(item.name)}
                                    onUpdateCart={updateCart}
                                />
                            ))}
                        </div>
                    </div>

                    {cart.length > 0 && (
                        <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mt-4">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-lg font-bold text-gray-800">
                                    ğŸ›’ è¨‚å–®æ˜ç´° ({cart.reduce((sum, item) => sum + item.quantity, 0)} é …)
                                </h2>
                                <button onClick={clearCart} className="text-xs bg-red-100 text-red-600 hover:bg-red-500 hover:text-white font-semibold py-1 px-3 rounded-full clickable-btn">
                                    ğŸ—‘ï¸ æ¸…ç©º
                                </button>
                            </div>
                            
                            <div className="space-y-2">
                                {cart.map(item => (
                                    <div key={item.name} className="flex justify-between items-center py-2 border-b border-gray-200">
                                        <div>
                                            <p className="font-bold text-gray-800 text-sm">{item.icon} {item.name}</p>
                                            <p className="text-xs text-gray-500">${item.price} x {item.quantity}</p>
                                        </div>
                                        <p className="font-bold text-green-600">${item.price * item.quantity}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    <div className="bg-green-50 p-4 rounded-lg border border-green-200 space-y-2 mt-4">
                        <div className="flex justify-between text-sm text-gray-600">
                            <span>é¤é»ç¸½è¨ˆ:</span>
                            <span>${subtotal}</span>
                        </div>
                        {deliveryFee > 0 && (
                            <div className="flex justify-between text-sm text-gray-600">
                                <span>å¤–é€è²»:</span>
                                <span>${deliveryFee}</span>
                            </div>
                        )}
                        <div className="flex justify-between font-bold text-lg text-gray-800 border-t border-gray-300 pt-3 mt-3">
                            <span>ç¸½é‡‘é¡:</span>
                            <span>${totalAmount}</span>
                        </div>
                    </div>

                    {/* é‡è¦æé†’ */}
                    <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <p className="text-sm text-blue-800 text-center">
                            <span className="font-bold">ğŸ“¨ é‡è¦æé†’ï¼š</span><br/>
                            ä¸‹å–®å¾Œè«‹å‹™å¿…ç™¼é€ç¢ºèªä¿¡çµ¦åº—å®¶ï¼Œå¾…åº—å®¶ç¢ºèªå¾Œè¨‚å–®æ‰æˆç«‹
                        </p>
                    </div>
                    
                    <div className="mt-6">
                        <button 
                            onClick={handleSubmit} 
                            disabled={cart.length === 0 || isLoading}
                            className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center clickable-btn"
                        >
                            {isLoading ? <><LoadingSpinner /><span>è™•ç†ä¸­...</span></> : <span>ğŸ“¨ é€å‡ºè¨‚å–®ï¼ˆå¾…ç¢ºèªï¼‰</span>}
                        </button>
                    </div>
                </div>
            );
        };

        // ä¸»æ‡‰ç”¨çµ„ä»¶
        const App = () => {
            const [view, setView] = useState('order');
            const [submittedOrder, setSubmittedOrder] = useState(null);
            const [notification, setNotification] = useState({ message: '', type: 'success', visible: false });
            const [menuItems, setMenuItems] = useState([]);
            const [isMenuLoading, setIsMenuLoading] = useState(true);

            const showNotification = useCallback((message, type = 'success') => {
                setNotification({ message, type, visible: true });
            }, []);

            useEffect(() => {
                const fetchMenu = async () => {
                    try {
                        const items = await apiService.getMenu();
                        setMenuItems(items);
                    } catch (error) {
                        setMenuItems(DEFAULT_MENU);
                    } finally {
                        setIsMenuLoading(false);
                    }
                };
                fetchMenu();
            }, []);

            const handleSubmitOrder = async (orderData, idToken) => {
                try {
                    const result = await apiService.submitOrder(orderData, idToken);
                    const finalOrderData = { 
                        ...orderData, 
                        orderId: result.data?.orderId || 'TEST_' + Date.now(), 
                        totalAmount: result.data?.totalAmount || orderData.items.reduce((sum, item) => sum + item.price * item.quantity, 0) + (orderData.deliveryAddress ? DELIVERY_FEE : 0)
                    };
                    setSubmittedOrder(finalOrderData);
                    setView('success');
                    showNotification('è¨‚å–®å·²æš«å­˜ï¼è«‹ç™¼é€ç¢ºèªä¿¡çµ¦åº—å®¶');
                } catch (error) {
                    showNotification(`è¨‚å–®æäº¤å¤±æ•—ï¼š${error.message}`, 'error');
                    throw error;
                }
            };

            const handleNewOrder = () => {
                setSubmittedOrder(null);
                setView('order');
            };

            const renderContent = () => {
                if (isMenuLoading) {
                    return (
                        <div className="text-center py-20 flex flex-col items-center justify-center text-gray-600">
                            <LoadingSpinner />
                            <p className="mt-3 text-sm">æ­£åœ¨è¼‰å…¥èœå–®...</p>
                        </div>
                    );
                }

                switch(view) {
                    case 'history':
                        return <HistoryPage onBack={() => setView('order')} showNotification={showNotification} />;
                    case 'success':
                        return submittedOrder && <SuccessPage orderData={submittedOrder} onNewOrder={handleNewOrder} showNotification={showNotification} />;
                    default:
                        return <OrderPage menuItems={menuItems} onSubmitOrder={handleSubmitOrder} showNotification={showNotification} onViewHistory={() => setView('history')} />;
                }
            };

            return (
                <div className="p-4 min-h-screen flex items-center justify-center">
                    <div className="container max-w-md mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
                        <div className="bg-[#fff3cd] border border-[#ffeaa7] rounded-t-2xl p-2.5 text-xs text-center text-[#856404]">
                            <span role="img" aria-label="lock">ğŸ”’</span> å®‰å…¨è¨‚é¤ç³»çµ± - éœ€åº—å®¶ç¢ºèªå¾Œæˆç«‹
                        </div>

                        <header className="bg-green-500 text-white p-5 text-center relative">
                            <h1 className="text-2xl font-bold mb-1">ğŸœ å°ç£å°åƒåº—</h1>
                            <p className="text-sm opacity-90">LINE å¿«é€Ÿè¨‚é¤ - éœ€åº—å®¶ç¢ºèª</p>
                        </header>

                        <main className="p-5 space-y-4">
                            <Notification 
                                message={notification.message} 
                                type={notification.type} 
                                visible={notification.visible} 
                                onClose={() => setNotification(prev => ({ ...prev, visible: false }))} 
                            />
                            {renderContent()}
                        </main>
                        
                        <footer className="bg-gray-100 p-4 text-center text-xs text-gray-500 border-t border-gray-200">
                            <p>ğŸ“ ç‡Ÿæ¥­æ™‚é–“: 10:00 - 21:00 | ğŸ“ è¯çµ¡é›»è©±: 02-1234-5678</p>
                            <p className="mt-1">ğŸ’¬ åº—å®¶LINE: {STORE_LINE_ID}</p>
                        </footer>
                    </div>
                </div>
            );
        };

        // æ¸²æŸ“æ‡‰ç”¨
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
